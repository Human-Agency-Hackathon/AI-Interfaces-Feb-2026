name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for breaking changes
        run: |
          echo "Checking for potential breaking changes..."
          git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -E "(server/src/|client/src/|shared/)" || true

      - name: Run all tests
        run: npm run test -w server

      - name: Build all packages
        run: |
          npm run build -w server
          npm run build -w client

      - name: Check bundle size
        run: |
          echo "Checking client bundle size..."
          du -sh client/dist || echo "No dist directory found"

  pr-labels:
    name: Check PR Labels
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Check for required labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const validLabels = ['bug', 'enhancement', 'documentation', 'refactor', 'ci', 'dependencies'];

            const hasValidLabel = labels.some(label => validLabels.includes(label));

            if (!hasValidLabel) {
              core.setFailed(`PR must have at least one of these labels: ${validLabels.join(', ')}`);
            } else {
              core.info(`PR has valid labels: ${labels.join(', ')}`);
            }

  pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            let size = 'XS';
            if (total > 1000) size = 'XL';
            else if (total > 500) size = 'L';
            else if (total > 200) size = 'M';
            else if (total > 50) size = 'S';

            core.info(`PR size: ${size} (${additions} additions, ${deletions} deletions)`);

            if (total > 1000) {
              core.warning('This PR is very large. Consider breaking it into smaller PRs for easier review.');
            }
